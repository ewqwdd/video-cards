const pauseBtnSvg = `<svg width="24" class="pauseBtn" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M15 5.5V18.5C15 18.9647 15 19.197 15.0384 19.3902C15.1962 20.1836 15.816 20.8041 16.6094 20.9619C16.8026 21.0003 17.0349 21.0003 17.4996 21.0003C17.9642 21.0003 18.1974 21.0003 18.3906 20.9619C19.184 20.8041 19.8041 20.1836 19.9619 19.3902C20 19.1987 20 18.9687 20 18.5122V5.48777C20 5.03125 20 4.80087 19.9619 4.60938C19.8041 3.81599 19.1836 3.19624 18.3902 3.03843C18.197 3 17.9647 3 17.5 3C17.0353 3 16.8026 3 16.6094 3.03843C15.816 3.19624 15.1962 3.81599 15.0384 4.60938C15 4.80257 15 5.03534 15 5.5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
<path d="M4 5.5V18.5C4 18.9647 4 19.197 4.03843 19.3902C4.19624 20.1836 4.81599 20.8041 5.60938 20.9619C5.80257 21.0003 6.0349 21.0003 6.49956 21.0003C6.96421 21.0003 7.19743 21.0003 7.39062 20.9619C8.18401 20.8041 8.8041 20.1836 8.96191 19.3902C9 19.1987 9 18.9687 9 18.5122V5.48777C9 5.03125 9 4.80087 8.96191 4.60938C8.8041 3.81599 8.18356 3.19624 7.39018 3.03843C7.19698 3 6.96465 3 6.5 3C6.03535 3 5.80257 3 5.60938 3.03843C4.81599 3.19624 4.19624 3.81599 4.03843 4.60938C4 4.80257 4 5.03534 4 5.5Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;
const playBtnSvg = `<svg width="24" class="playBtn" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M5 17.3336V6.66698C5 5.78742 5 5.34715 5.18509 5.08691C5.34664 4.85977 5.59564 4.71064 5.87207 4.67499C6.18868 4.63415 6.57701 4.84126 7.35254 5.25487L17.3525 10.5882L17.3562 10.5898C18.2132 11.0469 18.642 11.2756 18.7826 11.5803C18.9053 11.8462 18.9053 12.1531 18.7826 12.4189C18.6418 12.7241 18.212 12.9537 17.3525 13.4121L7.35254 18.7454C6.57645 19.1593 6.1888 19.3657 5.87207 19.3248C5.59564 19.2891 5.34664 19.1401 5.18509 18.9129C5 18.6527 5 18.2132 5 17.3336Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;
const volumeMaxSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M18.82 4.68646C19.8191 5.61815 20.6167 6.74466 21.1636 7.99651C21.7105 9.24836 21.9952 10.599 21.9999 11.9651C22.0047 13.3312 21.7295 14.6838 21.1914 15.9394C20.6532 17.1951 19.8635 18.3271 18.8709 19.2657M16.092 7.61188C16.6915 8.17089 17.17 8.8468 17.4982 9.5979C17.8263 10.349 17.9971 11.1594 18 11.9791C18.0028 12.7987 17.8377 13.6103 17.5148 14.3636C17.1919 15.117 16.7181 15.7963 16.1225 16.3594M7.4803 15.4069L9.15553 17.48C10.0288 18.5607 10.4655 19.101 10.848 19.1598C11.1792 19.2108 11.5138 19.0924 11.7394 18.8447C12 18.5585 12 17.8638 12 16.4743V7.52566C12 6.13621 12 5.44149 11.7394 5.1553C11.5138 4.90755 11.1792 4.78923 10.848 4.84015C10.4655 4.89897 10.0288 5.43933 9.15553 6.52003L7.4803 8.59313C7.30388 8.81145 7.21567 8.92061 7.10652 8.99916C7.00982 9.06875 6.90147 9.1205 6.78656 9.15197C6.65687 9.1875 6.51652 9.1875 6.23583 9.1875H4.8125C4.0563 9.1875 3.6782 9.1875 3.37264 9.28844C2.77131 9.48709 2.2996 9.95881 2.10094 10.5601C2 10.8657 2 11.2438 2 12C2 12.7562 2 13.1343 2.10094 13.4399C2.2996 14.0412 2.77131 14.5129 3.37264 14.7116C3.6782 14.8125 4.0563 14.8125 4.8125 14.8125H6.23583C6.51652 14.8125 6.65687 14.8125 6.78656 14.848C6.90147 14.8795 7.00982 14.9312 7.10652 15.0008C7.21567 15.0794 7.30388 15.1885 7.4803 15.4069Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;
const volumeOffSvg = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
<path d="M16.1716 9.17117L21.8284 14.828M16.1716 14.828L21.8284 9.17117M7.4803 15.4065L9.15553 17.4796C10.0288 18.5603 10.4655 19.1006 10.848 19.1594C11.1792 19.2104 11.5138 19.092 11.7394 18.8443C12 18.5581 12 17.8634 12 16.4739V7.52526C12 6.13581 12 5.44109 11.7394 5.1549C11.5138 4.90715 11.1792 4.78884 10.848 4.83975C10.4655 4.89858 10.0288 5.43893 9.15553 6.51963L7.4803 8.59273C7.30388 8.81105 7.21567 8.92021 7.10652 8.99876C7.00982 9.06835 6.90147 9.1201 6.78656 9.15158C6.65687 9.1871 6.51652 9.1871 6.23583 9.1871H4.8125C4.0563 9.1871 3.6782 9.1871 3.37264 9.28804C2.77131 9.4867 2.2996 9.95841 2.10094 10.5597C2 10.8653 2 11.2434 2 11.9996C2 12.7558 2 13.1339 2.10094 13.4395C2.2996 14.0408 2.77131 14.5125 3.37264 14.7112C3.6782 14.8121 4.0563 14.8121 4.8125 14.8121H6.23583C6.51652 14.8121 6.65687 14.8121 6.78656 14.8476C6.90147 14.8791 7.00982 14.9308 7.10652 15.0004C7.21567 15.079 7.30388 15.1881 7.4803 15.4065Z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
</svg>
`;

const disableFullScreen = (video) => {
  video.addEventListener("webkitfullscreenchange", function (event) {
    document.webkitExitFullscreen();
  });

  video.addEventListener("mozfullscreenchange", function (event) {
    document.mozCancelFullScreen();
  });

  video.addEventListener("msfullscreenchange", function (event) {
    document.msExitFullscreen();
  });

  video.addEventListener("fullscreenchange", function (event) {
    document.exitFullscreen();
  });

  video.addEventListener("fullscreenchange", function (event) {
    document.exitFullscreen();
  });
  video.addEventListener(
    "contextmenu",
    function (e) {
      e.preventDefault();
      e.stopPropagation();
    },
    false
  );
};

class Question {
  videoWrapper = undefined;
  constructor(id, buttons, wrapper, video, className) {
    this.id = id;
    this.buttons = buttons;
    this.wrapper = wrapper;
    this.video = video;
    this.className = className;
  }

  destroy() {
    if (this.videoWrapper) {
      this.videoWrapper.remove();
      this.videoWrapper = undefined;
    }
  }

  dissapear() {
    this.videoWrapper.classList.add("qzz__video_wrapper_disappear");
    setTimeout(() => {
      this.destroy();
    }, 400);
  }

  appear(animation = true) {
    this.videoWrapper.style.display = "flex";
    if (animation) {
      setTimeout(() => this.video.play(), 500);
      this.videoWrapper.classList.add("qzz__video_wrapper_appear");
      setTimeout(() => {
        this.videoWrapper.classList.remove("qzz__video_wrapper_appear");
      }, 500);
    } else {
      setTimeout(() => this.video.play(), 800);
    }
  }

  updateProgressBar(videoElement) {
    const duration = videoElement.duration;
    if (duration > 0) {
      this.progressBar.style.width = (videoElement.currentTime / duration) * 100 + "%";
      this.updateTimeDisplay(videoElement);
    }
  }

  handleProgressBarClick(event, videoElement) {
    event.stopPropagation();
    const rect = event.target.getBoundingClientRect();
    const clickPosition = event.offsetX; // Позиция клика относительно начала прогресс-бара
    const clickRatio = clickPosition / rect.width; // Доля, на которую кликнули
    const newTime = clickRatio * videoElement.duration; // Новое время воспроизведения
    videoElement.currentTime = newTime;
  }

  toggleMute(videoElement) {
    videoElement.muted = !videoElement.muted;
    this.muteButton.innerHTML = videoElement.muted ? volumeOffSvg : volumeMaxSvg;
  }

  updateTimeDisplay(videoElement) {
    const currentTime = this.formatTime(videoElement.currentTime);
    const duration = this.formatTime(videoElement.duration);
    this.timeDisplay.textContent = `${currentTime} / ${duration}`;
  }

  formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs < 10 ? "0" : ""}${secs}`;
  }

  videoTogle(videoElement) {
    if (!videoElement.paused) {
      this.wrapper.classList.add("paused");
      videoElement.pause();
    } else {
      this.wrapper.classList.remove("paused");
      videoElement.play();
    }
  }

  render(next) {
    const videoWrapper = document.createElement("div");
    videoWrapper.classList.add("qzz__video_wrapper");
    if (this.className) {
      videoWrapper.classList.add(this.className);
    }
    // video
    const video = document.createElement("video");
    video.classList = "qzz__video";
    video.setAttribute("playsinline", "");
    video.setAttribute("webkit-playsinline", "");
    video.setAttribute("src", this.video);
    video.setAttribute("type", "video/mp4");

    video.addEventListener("timeupdate", () => {
      this.updateProgressBar(video);
    });

    disableFullScreen(video);

    videoWrapper.appendChild(video);
    this.video = video;

    videoWrapper.style.pointerEvents = "none";

    video.addEventListener("canplay", () => {
      // Разблокируем взаимодействие после полной загрузки
      videoWrapper.style.pointerEvents = "auto";
    });

    // wrapper header
    const headerWrapper = document.createElement("div");
    headerWrapper.classList.add("qzz__header");

    // progress bar
    const progressBarContainer = document.createElement("div");
    progressBarContainer.classList.add("qzz__progress-bar-container");
    this.progressBar = document.createElement("div");
    this.progressBar.classList.add("qzz__progress-bar");
    progressBarContainer.appendChild(this.progressBar);
    progressBarContainer.addEventListener("click", (event) => {
      this.handleProgressBarClick(event, video);
    });
    videoWrapper.appendChild(progressBarContainer);

    // play btn
    const playBtn = document.createElement("button");
    playBtn.classList.add("qzz__pause_button");
    playBtn.innerHTML = playBtnSvg + pauseBtnSvg;
    videoWrapper.addEventListener("click", () => {
      this.videoTogle(video);
    });
    videoWrapper.appendChild(playBtn);

    // Отображение времени
    this.timeDisplay = document.createElement("div");
    this.timeDisplay.classList.add("qzz__time_display");
    this.timeDisplay.textContent = "0:00 / 0:00";
    this.timeDisplay.onclick = (e) => e.stopPropagation();
    headerWrapper.appendChild(this.timeDisplay);

    videoWrapper.appendChild(headerWrapper);

    // mute button
    this.muteButton = document.createElement("button");
    this.muteButton.classList.add("qzz__mute_button");
    this.muteButton.innerHTML = volumeMaxSvg;
    this.muteButton.addEventListener("click", (e) => {
      e.stopPropagation();
      this.toggleMute(video);
    });
    headerWrapper.appendChild(this.muteButton);

    // buttons
    this.buttons.forEach((button) => {
      const buttonElement = document.createElement("button");
      buttonElement.className = "qzz__button";
      buttonElement.innerHTML = button.html;
      buttonElement.onclick = (e) => {
        e.stopPropagation();
        button.onclick?.(e);
        next(button);
      };
      videoWrapper.appendChild(buttonElement);
    });
    this.wrapper.appendChild(videoWrapper);
    this.videoWrapper = videoWrapper;
  }
}

class Quiz {
  rendered = [];
  answers = {};
  prev;
  current;
  started = false;
  timeout;

  constructor(questions, wrapper, options = {}) {
    this.questions = questions.map((q) => new Question(q.id, q.buttons, wrapper, q.video, q.className));
    this.options = options;
    this.wrapper = wrapper;
    if (options.trigger) {
      options.trigger.onclick = (e) => {
        e.stopPropagation();
        const overlay = trigger.querySelector(".overlay");
        if (!this.started) {
          this.wrapper.style.display = "flex";
          overlay?.classList?.add?.("playing");
          this.wrapper?.classList?.remove?.("paused");
          options.trigger.querySelector("video")?.pause?.();
          this.positionVideo();
          this.wrapper.classList.add("qzz__appear");
          this.start();
        } else {
          const display = this.wrapper.style.display;
          if (display === "none") {
            this.wrapper.style.display = "flex";
            this.current?.video?.play?.();
            overlay?.classList?.add?.("playing");
            this.wrapper?.classList?.remove?.("paused");
            options.trigger.querySelector("video")?.pause?.();
            this.positionVideo();
            this.wrapper.classList.add("qzz__appear");
          } else {
            this.close();
          }
        }
      };
    }
    document.addEventListener("click", () => {
      this.close();
    });
    this.wrapper.addEventListener("click", (e) => {
      e.stopPropagation();
    });
    this.wrapper.addEventListener("mousemove", () => {
      const btn = this.wrapper.querySelector(".qzz__pause_button");
      if (this.timeout) {
        clearTimeout(this.timeout);
      }
      if (this.started) {
        btn.style.opacity = 1;
        this.timeout = setTimeout(() => {
          btn.style.opacity = 0;
        }, 1000);
      }
    });
  }

  close() {
    const overlay = trigger.querySelector(".overlay");
    this.wrapper.style.display = "none";
    this.current?.video?.pause?.();
    overlay?.classList?.remove?.("playing");
    this.wrapper?.classList?.add?.("paused");
    this.options.trigger.querySelector("video")?.play?.();
    this.wrapper.classList.remove("qzz__appear");
  }

  positionVideo() {
    const iconRect = trigger.getBoundingClientRect();
    const videoRect = this.wrapper.getBoundingClientRect();

    let topPosition = iconRect.bottom - videoRect.height;
    let leftPosition = iconRect.left - videoRect.width;

    // Проверка и корректировка позиции если видео выходит за границы экрана
    if (topPosition < 0) {
      topPosition = iconRect.top + iconRect.height; // Выровнять верх видео с верхом иконки
    }
    if (leftPosition < 0) {
      leftPosition = iconRect.left; // Выровнять левый край видео с левым краем иконки
    }
    if (topPosition + videoRect.height > window.innerHeight) {
      topPosition = window.innerHeight - videoRect.height; // Придвинуть к нижнему краю окна
    }
    if (leftPosition + videoRect.width > window.innerWidth) {
      leftPosition = window.innerWidth - videoRect.width; // Придвинуть к правому краю окна
    }

    this.wrapper.style.top = window.innerWidth > 420 ? `${topPosition}px` : "10px";
    this.wrapper.style.left = window.innerWidth > 420 ? `${leftPosition}px` : undefined;

    const originX = ((iconRect.left - leftPosition + iconRect.width / 2) / videoRect.width) * 100;
    const originY = ((iconRect.top - topPosition + iconRect.height / 2) / videoRect.height) * 100;

    this.wrapper.style.transformOrigin = `${originX}% ${originY}%`;
    this.wrapper.classList.add("qzz__appear");
  }

  quizEnd() {
    // this.prev?.dissapear?.();
    // this.rendered = [];
    // const quizFinish = document.createElement("div");
    // quizFinish.classList.add("qzz_quiz_finish");
    // quizFinish.classList.add("qzz__video_wrapper_appear");
    // quizFinish.innerHTML = this.options?.finishHtml ?? "<h2>Quiz is finished!</h2>";
    // this.wrapper.appendChild(quizFinish);
    this.options?.onFinish?.(this.answers);
    // this.started = false;
  }

  renderQuestion(id) {
    const found = this.questions.find((elem) => elem.id === id);
    const renderFound = this.rendered.find((elem) => elem.id === id);

    if (found && !renderFound) {
      const cb = (button) => {
        this.appearQuestion(button.nextId);
        this.answers[found.id] = {
          answer: button.answer,
        };
      };
      found.render?.(cb);
      this.rendered.push(found);
    }
  }

  appearQuestion(id, animation = true) {
    const renderFound = this.rendered.find((elem) => elem.id === id);
    this.current = renderFound;
    if (!renderFound) {
      this.quizEnd();
      console.log(this.answers);
      return;
    }
    renderFound.buttons.forEach((elem) => {
      this.renderQuestion(elem.nextId);
    });
    renderFound.appear?.(animation);
    this.prev?.dissapear?.();
    this.prev = renderFound;
  }

  start() {
    if (this.started) return;
    this.renderQuestion(this.questions?.[0].id);
    this.appearQuestion(this.questions?.[0].id, false);
    this.started = true;
  }
}
